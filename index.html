<html>
<head>
<!doctype = html5>
<meta charset = "utf-8">
<title>cad.io</title>

<configuration>
  <system.webServer>
    <httpProtocol>
        <add name="Access-Control-Allow-Origin" value="*" />

    </httpProtocol>
  </system.webServer>
</configuration>

</head>
<body>
<h1>CAD.IO </h1> 
<br>
</body>
<div class = "parameters">
  <label for="inputfiles" class = "btn">Select file from computer:</label>
<input type="file" id= "inputfiles" webkitdirectory directory multiple>

<label for="inputfiles" class = "btn">Select file from google drive:</label>
<input type="button" id= "drivefiles" onclick="loadPicker()" value = "Choose Files" webkitdirectory directory multiple>
<br>

<label for="imagetype">Select Image Type</label>

<select name="imagetype" id="imagetype">
  <option value="Xray">X-ray</option>
  <option value="CT">CT-scan</option>
  <option value="Mammogram">Mammogram</option>
</select>

Adjust Model Sensitivity
<input type="range" min="1" max="100" value="50" class="slider" id="sensitivity">

<button id="authorize_button" style="display: none;">Authorize</button>
<button id="signout_button" style="display: none;">Sign Out</button>

<pre id="content" style="white-space: pre-wrap;"></pre>
</div>

<div id="dicomVeiwer" style="width:512px;height:512px">
</div>
	
<div id="toolbar">
    <input type="radio" id="imagescroll" name="tools", onchange="toolSelect();">
    <label for="contrast">Image Scroll</label>
    <input type="radio" id="contrast" name="tools",  onchange="toolSelect();">
    <label for="contrast">Contrast</label>
    <input type="radio" id="ruler" name="tools",  onchange="toolSelect();">
    <label for="ruler">Ruler</label> 
    <input type="radio" id="zoom" name="tools",  onchange="toolSelect();">
    <label for="zoom">Zoom</label>
    <input type="radio" id="crosshair" name="tools",  onchange="toolSelect();">
    <label for="crosshair">Crosshair</label>
</div>



<script src="jquery.js"></script>
<script src="jpx.min.js"></script>


<script type="text/javascript">

// cd documents cd ds440 cd dicom viewer 
//python3 -m http.server 
//localhost:8000

    // Client ID and API key from the Developer Console
    var CLIENT_ID = '806051351940-hcuudcsuuq5u5u398m8b1midf6k56k0l.apps.googleusercontent.com';
    var API_KEY = 'AIzaSyC1NFRYOu9hWADCbECV77TWUsVbObXiuoQ';

    // Array of API discovery doc URLs for APIs used by the quickstart
    var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];

    // Authorization scopes required by the API; multiple scopes can be
    // included, separated by spaces.
    var SCOPES = 'https://www.googleapis.com/auth/drive.metadata.readonly';

    var authorizeButton = document.getElementById('authorize_button');
    var signoutButton = document.getElementById('signout_button');

    /**
     *  On load, called to load the auth2 library and API client library.
     */
    function handleClientLoad() {
      gapi.load('client:auth2', initClient);
    }

    /**
     *  Initializes the API client library and sets up sign-in state
     *  listeners.
     */
    function initClient() {
      gapi.client.init({
        apiKey: API_KEY,
        clientId: CLIENT_ID,
        discoveryDocs: DISCOVERY_DOCS,
        scope: SCOPES
      }).then(function () {
        // Listen for sign-in state changes.
        gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

        // Handle the initial sign-in state.
        updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
        authorizeButton.onclick = handleAuthClick;
        signoutButton.onclick = handleSignoutClick;
      }, function(error) {
        appendPre(JSON.stringify(error, null, 2));
      });
    }

    /**
     *  Called when the signed in status changes, to update the UI
     *  appropriately. After a sign-in, the API is called.
     */
    function updateSigninStatus(isSignedIn) {
      if (isSignedIn) {
        authorizeButton.style.display = 'none';
        signoutButton.style.display = 'block';
        // listFiles();
      } else {
        authorizeButton.style.display = 'block';
        signoutButton.style.display = 'none';
      }
    }

    /**
     *  Sign in the user upon button click.
     */
    function handleAuthClick(event) {
      gapi.auth2.getAuthInstance().signIn();
    }

    /**
     *  Sign out the user upon button click.
     */
    function handleSignoutClick(event) {
      gapi.auth2.getAuthInstance().signOut();
    }

    /**
     * Append a pre element to the body containing the given message
     * as its text node. Used to display the results of the API call.
     *
     * @param {string} message Text to be placed in pre element.
     */
    function appendPre(message) {
      var pre = document.getElementById('content');
      var textContent = document.createTextNode(message + '\n');
      pre.appendChild(textContent);
    }
    

    /**
     * Print files.
     
    function listFiles() {
      gapi.client.drive.files.list({
        'pageSize': 10,
        'fields': "nextPageToken, files(id, name)"
      }).then(function(response) {
        appendPre('Files:');
        var files = response.result.files;
        if (files && files.length > 0) {
          for (var i = 0; i < files.length; i++) {
            var file = files[i];
            appendPre(file.name + ' (' + file.id + ')');
          }
        } else {
          appendPre('No files found.');
        }
      });
    }
    */

  </script>

<!-- Load the Google API Loader script. -->
<script type="text/javascript" src="https://apis.google.com/js/api.js?onload=loadPicker"></script>

<!--Create google file picker -->
<script>
  console.log(0);
  var developerKey = 'AIzaSyC1NFRYOu9hWADCbECV77TWUsVbObXiuoQ';

  // The Client ID obtained from the Google API Console. Replace with your own Client ID.
  var clientId = "806051351940-hcuudcsuuq5u5u398m8b1midf6k56k0l.apps.googleusercontent.com"

  // Replace with your own project number from console.developers.google.com.
  // See "Project number" under "IAM & Admin" > "Settings"
  var appId = "crypto-groove-329712";

  // Scope to use to access user's Drive items.
  var scope = ['https://www.googleapis.com/auth/drive'];

  var pickerApiLoaded = false;
  var oauthToken;

  // Use the Google API Loader script to load the google.picker script.
  function loadPicker() {
    console.log(1);
    gapi.load('auth', {'callback': onAuthApiLoad});
    console.log(2);
    gapi.load('picker', {'callback': onPickerApiLoad});
  }

  function onAuthApiLoad() {
    console.log(3.1);
    window.gapi.auth.authorize(
        {
          'client_id': clientId,
          'scope': scope,
          'immediate': false
        },
        handleAuthResult);
  }

  function onPickerApiLoad() {
    console.log(3.2);
    pickerApiLoaded = true;
    createPicker();
  }

  function handleAuthResult(authResult) {
    console.log(4);
    if (authResult && !authResult.error) {
      oauthToken = authResult.access_token;
      createPicker();
    }
  }

  // Create and render a Picker object for searching images.
  function createPicker() {
    console.log(5);
    if (pickerApiLoaded && oauthToken) {
      console.log(6);
      var view = new google.picker.DocsView(google.picker.ViewId.DOCS)
      .setSelectFolderEnabled(true)
      .setIncludeFolders(true);
      var picker = new google.picker.PickerBuilder()
          .enableFeature(google.picker.Feature.NAV_HIDDEN)
          .enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
          .setAppId(appId)
          .setOAuthToken(oauthToken)
          .addView(view)
          .addView(new google.picker.DocsUploadView())
          .setDeveloperKey(developerKey)
          .setCallback(pickerCallback)
          .build();
      picker.setVisible(true);
      console.log(this.data);
    }
  }

  // A simple callback implementation.
  function pickerCallback(data) {
    console.log(8);
    if (data.action == google.picker.Action.PICKED) {
      console.log(7);
      var fileId = data.docs[0].id;
      let fileList = gapi.client.drive.files.list({
          folderId: fileId
          //fields: 'webContentLink'
      }).then(function(success){
    
      console.log("anything");
      console.log(success);
      var fileId = success.result.files[1];
      var xhr = new XMLHttpRequest();
      var url = "https://www.googleapis.com/drive/v3/files/" + fileId + "?alt=media";
      var accessToken = gapi.auth.getToken().access_token;
      xhr.open('GET', url);
      xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);   
      xhr.responseType = "blob";
      xhr.addEventListener('load', function(e) {
        var blob = this.response;//this is your blob file
        console.log("somthing");
        console.log(blob);
      });
      xhr.send();  

      }); 
  }   
}

    function getFile(fileList, index){

          //var xhr = new XMLHttpRequest();
          //for (let i = 0; i < success.result.files.length; i++) {
          let dicomfile = gapi.client.drive.files.get({
            fileId: fileList.result.files[index].id,
            alt: 'media',
            mimeType: "application/dicom"
             
          });
          return dicomfile
      }


</script>




<script async defer src="https://apis.google.com/js/api.js"
      onload="this.onload=function(){};handleClientLoad()"
      onreadystatechange="if (this.readyState === 'complete') this.onload()">
</script>






<script src="cornerstone.min.js"></script> 
<script src="dicomParser.min.js"></script>
<script src="cornerstoneWADOImageLoader.min.js"></script>
<script src="cornerstoneFileImageLoader.js"></script>
<script src="jpx.min.js"></script>
<script type= "text/javascript">
    var position = 0;
    var num_files = 0;
    var imageIds = [];
    var contrast = 50;

  $("#drivefiles").on("change", function(e){
    console.log(e);
    console.log("hi");
  });








    $(document).ready(function() {
        var element = $('#dicomVeiwer').get(0);
        cornerstone.enable(element);
        $('#inputfiles').on('change', function(e) {
            position = 0;
            num_files = e.target.files.length;
            for (let i = 0; i < e.target.files.length; i++) {
                 
                var file = e.target.files[i];
                var index = cornerstoneFileImageLoader.addFile(file);
                var imageId = "dicomfile://" + index;
                imageIds.push(imageId);  
                var element = $('#dicomVeiwer').get(0);
                cornerstone.loadImage(imageId).then(function(image) {
                cornerstone.displayImage(element, image);
            });
        }
        }); 
    });
    function toolSelect(){
        if(document.getElementById("imagescroll").checked){
            document.getElementById("dicomVeiwer").onwheel = function(event) {
                if (event.deltaY < 0){
                    if(position == num_files-1){     
                    } else {
                        var element = $('#dicomVeiwer').get(0);
                        position = position + 1;
                        cornerstone.loadImage(imageIds[position]).then(function(image) {
                        image.slope= contrast/50 
                        cornerstone.displayImage(element, image);
                        });
                        console.log(position);
                    }
                } else if (event.deltaY > 0){

                    if(position == 0){
            
                    } else {
                        var element = $('#dicomVeiwer').get(0);
                        position = position - 1;
                        cornerstone.loadImage(imageIds[position]).then(function(image) {
                        image.slope= contrast/50 
                        cornerstone.displayImage(element, image);
                        });
                        console.log(position);
                    }
                }
                };
        }
        if(document.getElementById("contrast").checked){
            console.log("contrast");
            document.getElementById("dicomVeiwer").onwheel = function(event) {
                if (event.deltaY < 0){
                    if(contrast < 0){
                    } else {
                        contrast = contrast - 1;
                        var element = $('#dicomVeiwer').get(0);
                        cornerstone.loadImage(imageIds[position+1]).then(function(image) {     
                            image.slope = contrast/50;
                            cornerstone.displayImage(element, image);
                        });
                        cornerstone.loadImage(imageIds[position]).then(function(image) {
                        image.slope = contrast/50;
                        console.log(image.slope, position);        
                        cornerstone.displayImage(element, image);       
                        });
                    }
                } else if (event.deltaY > 0){
                    if(contrast > 100){
                    } else {
                        contrast = contrast + 1;
                        var element = $('#dicomVeiwer').get(0);
                        cornerstone.loadImage(imageIds[position+1]).then(function(image) {     
                        image.slope = contrast/50;
                        cornerstone.displayImage(element, image);
                        });
                        cornerstone.loadImage(imageIds[position]).then(function(image) {
                        image.slope = contrast/50;
                        cornerstone.displayImage(element, image);       
                        });
                    }        
                }
            }
        }
    }
</script>

</html>